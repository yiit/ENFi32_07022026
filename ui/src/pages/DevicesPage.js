/**\n * DevicesPage Component\n * ENFi32 Dashboard v2.0 - Device Management Interface\n */\n\nimport { h } from 'preact';\nimport { useState, useEffect } from 'preact/hooks';\nimport { ApiService } from '../services/ApiService';\nimport { SettingsService } from '../services/SettingsService';\n\nexport const DevicesPage = () => {\n    const [devices, setDevices] = useState([]);\n    const [loading, setLoading] = useState(true);\n    const [selectedDevice, setSelectedDevice] = useState(null);\n    const [filterStatus, setFilterStatus] = useState('all');\n    const [searchTerm, setSearchTerm] = useState('');\n    const [showAddModal, setShowAddModal] = useState(false);\n\n    useEffect(() => {\n        loadDevices();\n        const interval = setInterval(loadDevices, 10000); // Update every 10 seconds\n        return () => clearInterval(interval);\n    }, []);\n\n    const loadDevices = async () => {\n        try {\n            const response = await ApiService.request('/json/devices');\n            setDevices(response.devices || []);\n        } catch (error) {\n            console.error('Failed to load devices:', error);\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const filteredDevices = devices.filter(device => {\n        const matchesStatus = filterStatus === 'all' || device.status === filterStatus;\n        const matchesSearch = device.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                            device.type.toLowerCase().includes(searchTerm.toLowerCase());\n        return matchesStatus && matchesSearch;\n    });\n\n    const getStatusColor = (status) => {\n        switch (status) {\n            case 'online': return 'var(--color-success)';\n            case 'offline': return 'var(--color-error)';\n            case 'warning': return 'var(--color-warning)';\n            default: return 'var(--text-muted)';\n        }\n    };\n\n    const getDeviceIcon = (type) => {\n        switch (type) {\n            case 'sensor': return 'üå°Ô∏è';\n            case 'relay': return 'üîå';\n            case 'switch': return 'üí°';\n            case 'dimmer': return 'üéõÔ∏è';\n            case 'servo': return '‚öôÔ∏è';\n            case 'motor': return 'üîÑ';\n            default: return 'üì±';\n        }\n    };\n\n    const toggleDevice = async (deviceId, currentState) => {\n        try {\n            await ApiService.request('/control', {\n                method: 'POST',\n                body: JSON.stringify({\n                    device: deviceId,\n                    state: currentState === 'ON' ? 'OFF' : 'ON'\n                })\n            });\n            loadDevices(); // Refresh devices\n        } catch (error) {\n            console.error('Failed to toggle device:', error);\n        }\n    };\n\n    const DeviceCard = ({ device }) => (\n        <div className=\"metric-card\">\n            <div className=\"card-header\">\n                <span className=\"card-icon\" style={{ fontSize: '28px' }}>\n                    {getDeviceIcon(device.type)}\n                </span>\n                <div className=\"card-title\">{device.name}</div>\n                <div \n                    className=\"status-indicator\" \n                    style={{ background: getStatusColor(device.status) }}\n                    title={device.status}\n                ></div>\n            </div>\n            \n            <div className=\"card-content\">\n                <div className=\"metric-row\">\n                    <span className=\"metric-label\">Type</span>\n                    <span className=\"metric-value\">{device.type}</span>\n                </div>\n                \n                <div className=\"metric-row\">\n                    <span className=\"metric-label\">GPIO</span>\n                    <span className=\"metric-value\">GPIO {device.gpio}</span>\n                </div>\n                \n                <div className=\"metric-row\">\n                    <span className=\"metric-label\">State</span>\n                    <span className=\"metric-value\" style={{ color: device.state === 'ON' ? 'var(--color-success)' : 'var(--text-muted)' }}>\n                        {device.state}\n                    </span>\n                </div>\n                \n                {device.value !== undefined && (\n                    <div className=\"metric-row\">\n                        <span className=\"metric-label\">Value</span>\n                        <span className=\"metric-value highlight\">{device.value}{device.unit || ''}</span>\n                    </div>\n                )}\n                \n                <div className=\"metric-row\" style={{ marginTop: 'var(--space-4)', paddingTop: 'var(--space-3)', borderTop: '1px solid var(--border-color)' }}>\n                    {device.type !== 'sensor' && (\n                        <button \n                            className={`control-btn ${device.state === 'ON' ? 'primary' : 'secondary'}`}\n                            onClick={() => toggleDevice(device.id, device.state)}\n                        >\n                            {device.state === 'ON' ? 'üî¥ Turn OFF' : 'üü¢ Turn ON'}\n                        </button>\n                    )}\n                    \n                    <button \n                        className=\"control-btn secondary\"\n                        onClick={() => setSelectedDevice(device)}\n                    >\n                        ‚öôÔ∏è Configure\n                    </button>\n                </div>\n            </div>\n        </div>\n    );\n\n    if (loading) {\n        return (\n            <div className=\"dashboard-loading\">\n                <div className=\"loading-content\">\n                    <div className=\"loading-spinner\"></div>\n                    <p>Loading devices...</p>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"dashboard-page\">\n            {/* Page Header */}\n            <div className=\"dashboard-header\">\n                <div className=\"header-content\">\n                    <div>\n                        <h1>üì± Device Management</h1>\n                        <p style={{ fontSize: '16px', opacity: 0.9, margin: '8px 0 0' }}>\n                            Manage and control all connected IoT devices\n                        </p>\n                    </div>\n                    <div className=\"header-controls\">\n                        <button className=\"control-btn primary\" onClick={() => setShowAddModal(true)}>\n                            ‚ûï Add Device\n                        </button>\n                        <button className=\"control-btn secondary\" onClick={loadDevices}>\n                            üîÑ Refresh\n                        </button>\n                    </div>\n                </div>\n            </div>\n\n            {/* Controls */}\n            <div style={{ marginBottom: 'var(--space-6)' }}>\n                <div className=\"flex flex-between flex-wrap\" style={{ gap: 'var(--space-4)', marginBottom: 'var(--space-4)' }}>\n                    {/* Search */}\n                    <div style={{ flex: '1', minWidth: '300px' }}>\n                        <input\n                            type=\"text\"\n                            className=\"form-input\"\n                            placeholder=\"üîç Search devices by name or type...\"\n                            value={searchTerm}\n                            onInput={(e) => setSearchTerm(e.target.value)}\n                        />\n                    </div>\n                    \n                    {/* Status Filter */}\n                    <div style={{ minWidth: '200px' }}>\n                        <select \n                            className=\"form-input form-select\"\n                            value={filterStatus}\n                            onChange={(e) => setFilterStatus(e.target.value)}\n                        >\n                            <option value=\"all\">All Devices</option>\n                            <option value=\"online\">Online</option>\n                            <option value=\"offline\">Offline</option>\n                            <option value=\"warning\">Warning</option>\n                        </select>\n                    </div>\n                </div>\n\n                {/* Quick Stats */}\n                <div className=\"flex flex-wrap\" style={{ gap: 'var(--space-4)' }}>\n                    <div className=\"badge success\">Total: {devices.length}</div>\n                    <div className=\"badge info\">Online: {devices.filter(d => d.status === 'online').length}</div>\n                    <div className=\"badge error\">Offline: {devices.filter(d => d.status === 'offline').length}</div>\n                    <div className=\"badge warning\">Warning: {devices.filter(d => d.status === 'warning').length}</div>\n                </div>\n            </div>\n\n            {/* Devices Grid */}\n            {filteredDevices.length > 0 ? (\n                <div className=\"metrics-grid\">\n                    {filteredDevices.map(device => (\n                        <DeviceCard key={device.id} device={device} />\n                    ))}\n                </div>\n            ) : (\n                <div className=\"chart-container\" style={{ textAlign: 'center', padding: 'var(--space-10)' }}>\n                    <h3 style={{ color: 'var(--text-muted)', marginBottom: 'var(--space-4)' }}>\n                        {searchTerm || filterStatus !== 'all' ? 'üîç No devices match your search' : 'üì± No devices found'}\n                    </h3>\n                    <p style={{ color: 'var(--text-secondary)', marginBottom: 'var(--space-6)' }}>\n                        {searchTerm || filterStatus !== 'all' \n                            ? 'Try adjusting your search or filter settings'\n                            : 'Start by adding your first IoT device'\n                        }\n                    </p>\n                    {!searchTerm && filterStatus === 'all' && (\n                        <button className=\"control-btn primary\" onClick={() => setShowAddModal(true)}>\n                            ‚ûï Add First Device\n                        </button>\n                    )}\n                </div>\n            )}\n\n            {/* Device Configuration Modal */}\n            {selectedDevice && (\n                <div className=\"modal-overlay active\">\n                    <div className=\"modal\">\n                        <div className=\"modal-header\">\n                            <h3 className=\"modal-title\">‚öôÔ∏è Configure {selectedDevice.name}</h3>\n                            <button className=\"modal-close\" onClick={() => setSelectedDevice(null)}>‚úï</button>\n                        </div>\n                        <div className=\"modal-body\">\n                            <div className=\"form-group\">\n                                <label className=\"form-label\">Device Name</label>\n                                <input type=\"text\" className=\"form-input\" value={selectedDevice.name} readOnly />\n                            </div>\n                            <div className=\"form-group\">\n                                <label className=\"form-label\">Type</label>\n                                <input type=\"text\" className=\"form-input\" value={selectedDevice.type} readOnly />\n                            </div>\n                            <div className=\"form-group\">\n                                <label className=\"form-label\">GPIO Pin</label>\n                                <input type=\"text\" className=\"form-input\" value={selectedDevice.gpio} readOnly />\n                            </div>\n                            <div className=\"alert info\">\n                                <div className=\"alert-icon\">‚ÑπÔ∏è</div>\n                                <div className=\"alert-content\">\n                                    <div className=\"alert-title\">Device Information</div>\n                                    <div className=\"alert-message\">\n                                        Status: <strong>{selectedDevice.status}</strong><br/>\n                                        State: <strong>{selectedDevice.state}</strong><br/>\n                                        Last Updated: <strong>{new Date().toLocaleString()}</strong>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div className=\"modal-footer\">\n                            <button className=\"control-btn secondary\" onClick={() => setSelectedDevice(null)}>\n                                Close\n                            </button>\n                            <button className=\"control-btn primary\">\n                                Save Changes\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            )}\n\n            {/* Add Device Modal */}\n            {showAddModal && (\n                <div className=\"modal-overlay active\">\n                    <div className=\"modal\">\n                        <div className=\"modal-header\">\n                            <h3 className=\"modal-title\">‚ûï Add New Device</h3>\n                            <button className=\"modal-close\" onClick={() => setShowAddModal(false)}>‚úï</button>\n                        </div>\n                        <div className=\"modal-body\">\n                            <div className=\"form-group\">\n                                <label className=\"form-label required\">Device Name</label>\n                                <input type=\"text\" className=\"form-input\" placeholder=\"Enter device name\" />\n                            </div>\n                            <div className=\"form-group\">\n                                <label className=\"form-label required\">Device Type</label>\n                                <select className=\"form-input form-select\">\n                                    <option value=\"\">Select device type</option>\n                                    <option value=\"sensor\">üå°Ô∏è Sensor</option>\n                                    <option value=\"relay\">üîå Relay</option>\n                                    <option value=\"switch\">üí° Switch</option>\n                                    <option value=\"dimmer\">üéõÔ∏è Dimmer</option>\n                                    <option value=\"servo\">‚öôÔ∏è Servo Motor</option>\n                                    <option value=\"motor\">üîÑ Motor</option>\n                                </select>\n                            </div>\n                            <div className=\"form-group\">\n                                <label className=\"form-label required\">GPIO Pin</label>\n                                <input type=\"number\" className=\"form-input\" placeholder=\"Enter GPIO pin number\" min=\"0\" max=\"39\" />\n                            </div>\n                            <div className=\"alert warning\">\n                                <div className=\"alert-icon\">‚ö†Ô∏è</div>\n                                <div className=\"alert-content\">\n                                    <div className=\"alert-message\">\n                                        Make sure the GPIO pin is not already in use by another device.\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div className=\"modal-footer\">\n                            <button className=\"control-btn secondary\" onClick={() => setShowAddModal(false)}>\n                                Cancel\n                            </button>\n                            <button className=\"control-btn primary\">\n                                Add Device\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n};"