/**\n * Modern Dashboard Page\n * Real-time IoT visualization with Chart.js\n */\n\nimport { h } from 'preact';\nimport { useState, useEffect, useRef } from 'preact/hooks';\nimport { ApiService } from '../services/ApiService';\nimport { SettingsService } from '../services/SettingsService';\nimport { useLoading } from '../components/LoadingProvider';\nimport { Chart, registerables } from 'chart.js';\n\n// Register Chart.js components\nChart.register(...registerables);\n\nexport function DashboardPage() {\n    const [systemData, setSystemData] = useState(null);\n    const [sensorData, setSensorData] = useState([]);\n    const [connectionStatus, setConnectionStatus] = useState(false);\n    const [autoRefresh, setAutoRefresh] = useState(true);\n    const { showLoading, hideLoading } = useLoading();\n    \n    // Chart refs\n    const tempChartRef = useRef(null);\n    const wifiChartRef = useRef(null);\n    const powerChartRef = useRef(null);\n    \n    // Chart instances\n    const [charts, setCharts] = useState({});\n    \n    // Data history\n    const [dataHistory, setDataHistory] = useState({\n        temperature: [],\n        humidity: [],\n        wifi: [],\n        power: [],\n        timestamps: []\n    });\n    \n    const maxDataPoints = SettingsService.get('charts.maxDataPoints', 50);\n    \n    useEffect(() => {\n        initializeDashboard();\n        \n        return () => {\n            // Cleanup\n            Object.values(charts).forEach(chart => {\n                if (chart) chart.destroy();\n            });\n            ApiService.stopRealTimeData();\n        };\n    }, []);\n    \n    useEffect(() => {\n        if (systemData) {\n            initializeCharts();\n        }\n    }, [systemData]);\n    \n    const initializeDashboard = async () => {\n        showLoading('Initializing Dashboard...');\n        \n        try {\n            // Check connection\n            const connected = await ApiService.checkConnection();\n            setConnectionStatus(connected);\n            \n            if (connected) {\n                // Load initial data\n                await loadSystemData();\n                \n                // Start real-time updates if enabled\n                if (SettingsService.get('dashboard.autoRefresh', true)) {\n                    startRealTimeUpdates();\n                }\n                \n                // Setup event listeners\n                ApiService.on('sensorData', handleSensorData);\n                ApiService.on('connection', handleConnectionChange);\n            }\n            \n        } catch (error) {\n            console.error('Dashboard initialization failed:', error);\n        } finally {\n            hideLoading();\n        }\n    };\n    \n    const loadSystemData = async () => {\n        try {\n            const data = await ApiService.getSystemInfo();\n            setSystemData(data);\n            \n            if (data && data.sensors.length > 0) {\n                setSensorData(data.sensors);\n                updateDataHistory(data);\n            }\n            \n        } catch (error) {\n            console.error('Failed to load system data:', error);\n        }\n    };\n    \n    const startRealTimeUpdates = () => {\n        const interval = SettingsService.get('dashboard.refreshInterval', 5000);\n        ApiService.startRealTimeData(interval);\n    };\n    \n    const handleSensorData = (data) => {\n        const parsedData = ApiService.parseSystemInfo(data);\n        setSystemData(parsedData);\n        setSensorData(parsedData.sensors);\n        updateDataHistory(parsedData);\n        updateCharts(parsedData);\n    };\n    \n    const handleConnectionChange = ({ connected }) => {\n        setConnectionStatus(connected);\n    };\n    \n    const updateDataHistory = (data) => {\n        const timestamp = new Date().toLocaleTimeString();\n        \n        setDataHistory(prev => {\n            const newHistory = { ...prev };\n            \n            // Add new data points\n            newHistory.timestamps.push(timestamp);\n            newHistory.temperature.push(data.sensors[0]?.Temperature || null);\n            newHistory.humidity.push(data.sensors[0]?.Humidity || null);\n            newHistory.wifi.push(data.wifi?.rssi || null);\n            newHistory.power.push(data.load || null);\n            \n            // Maintain size limit\n            Object.keys(newHistory).forEach(key => {\n                if (newHistory[key].length > maxDataPoints) {\n                    newHistory[key].shift();\n                }\n            });\n            \n            return newHistory;\n        });\n    };\n    \n    const initializeCharts = () => {\n        // Temperature Chart\n        if (tempChartRef.current) {\n            const tempChart = createTemperatureChart(tempChartRef.current);\n            setCharts(prev => ({ ...prev, temperature: tempChart }));\n        }\n        \n        // WiFi Signal Chart\n        if (wifiChartRef.current) {\n            const wifiChart = createWiFiChart(wifiChartRef.current);\n            setCharts(prev => ({ ...prev, wifi: wifiChart }));\n        }\n        \n        // Power Chart\n        if (powerChartRef.current) {\n            const powerChart = createPowerChart(powerChartRef.current);\n            setCharts(prev => ({ ...prev, power: powerChart }));\n        }\n    };\n    \n    const createTemperatureChart = (canvas) => {\n        return new Chart(canvas, {\n            type: 'line',\n            data: {\n                labels: dataHistory.timestamps,\n                datasets: [{\n                    label: 'Temperature (¬∞C)',\n                    data: dataHistory.temperature,\n                    borderColor: '#FF6B6B',\n                    backgroundColor: 'rgba(255, 107, 107, 0.1)',\n                    borderWidth: 2,\n                    fill: true,\n                    tension: 0.4,\n                    pointStyle: 'circle',\n                    pointRadius: 4,\n                    pointHoverRadius: 6\n                }]\n            },\n            options: getChartOptions({\n                title: 'Temperature Trend',\n                yAxis: { min: 0, max: 50, unit: '¬∞C' }\n            })\n        });\n    };\n    \n    const createWiFiChart = (canvas) => {\n        const signal = Math.abs(systemData?.wifi?.rssi || 0);\n        const quality = signal > 70 ? 90 : signal > 50 ? 70 : 50;\n        \n        return new Chart(canvas, {\n            type: 'doughnut',\n            data: {\n                labels: ['Signal Strength', 'Loss'],\n                datasets: [{\n                    data: [quality, 100 - quality],\n                    backgroundColor: ['#4ECDC4', '#E5E5E5'],\n                    borderWidth: 0,\n                    cutout: '70%'\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: { display: false },\n                    tooltip: {\n                        callbacks: {\n                            label: (context) => `${context.label}: ${context.parsed}%`\n                        }\n                    }\n                }\n            }\n        });\n    };\n    \n    const createPowerChart = (canvas) => {\n        return new Chart(canvas, {\n            type: 'bar',\n            data: {\n                labels: dataHistory.timestamps.slice(-10),\n                datasets: [{\n                    label: 'CPU Load (%)',\n                    data: dataHistory.power.slice(-10),\n                    backgroundColor: '#45B7D1',\n                    borderColor: '#3A9BC1',\n                    borderWidth: 1\n                }]\n            },\n            options: getChartOptions({\n                title: 'System Load',\n                yAxis: { min: 0, max: 100, unit: '%' }\n            })\n        });\n    };\n    \n    const getChartOptions = ({ title, yAxis }) => {\n        return {\n            responsive: true,\n            maintainAspectRatio: false,\n            plugins: {\n                title: {\n                    display: true,\n                    text: title,\n                    color: 'var(--text-primary)',\n                    font: { size: 16, weight: 'bold' }\n                },\n                legend: {\n                    display: true,\n                    position: 'top',\n                    labels: {\n                        usePointStyle: true,\n                        color: 'var(--text-secondary)',\n                        font: { size: 12 }\n                    }\n                }\n            },\n            scales: {\n                x: {\n                    grid: { color: 'rgba(255,255,255,0.1)' },\n                    ticks: { color: 'var(--text-secondary)', font: { size: 10 } }\n                },\n                y: {\n                    ...yAxis,\n                    grid: { color: 'rgba(255,255,255,0.1)' },\n                    ticks: { color: 'var(--text-secondary)', font: { size: 10 } },\n                    title: {\n                        display: true,\n                        text: yAxis.unit,\n                        color: 'var(--text-secondary)'\n                    }\n                }\n            },\n            animation: {\n                duration: SettingsService.get('charts.animationDuration', 750)\n            }\n        };\n    };\n    \n    const updateCharts = (data) => {\n        // Update temperature chart\n        if (charts.temperature) {\n            charts.temperature.data.labels = dataHistory.timestamps;\n            charts.temperature.data.datasets[0].data = dataHistory.temperature;\n            charts.temperature.update('none');\n        }\n        \n        // Update WiFi chart\n        if (charts.wifi && data.wifi) {\n            const signal = Math.abs(data.wifi.rssi);\n            const quality = signal > 70 ? 90 : signal > 50 ? 70 : 50;\n            charts.wifi.data.datasets[0].data = [quality, 100 - quality];\n            charts.wifi.update('none');\n        }\n        \n        // Update power chart\n        if (charts.power) {\n            charts.power.data.labels = dataHistory.timestamps.slice(-10);\n            charts.power.data.datasets[0].data = dataHistory.power.slice(-10);\n            charts.power.update('none');\n        }\n    };\n    \n    const toggleAutoRefresh = () => {\n        const newState = !autoRefresh;\n        setAutoRefresh(newState);\n        SettingsService.set('dashboard.autoRefresh', newState);\n        \n        if (newState) {\n            startRealTimeUpdates();\n        } else {\n            ApiService.stopRealTimeData();\n        }\n    };\n    \n    const refreshData = async () => {\n        showLoading('Refreshing data...');\n        await loadSystemData();\n        hideLoading();\n    };\n    \n    if (!systemData) {\n        return (\n            <div className=\"dashboard-loading\">\n                <div className=\"loading-content\">\n                    <div className=\"loading-spinner\"></div>\n                    <p>Loading dashboard...</p>\n                </div>\n            </div>\n        );\n    }\n    \n    return (\n        <div className=\"dashboard-page\">\n            {/* Header */}\n            <div className=\"dashboard-header\">\n                <div className=\"header-content\">\n                    <h1>üöÄ ENFi32 Professional Dashboard</h1>\n                    <div className=\"header-controls\">\n                        <button \n                            className=\"control-btn primary\"\n                            onClick={refreshData}\n                        >\n                            üîÑ Refresh\n                        </button>\n                        \n                        <label className=\"toggle-switch\">\n                            <input \n                                type=\"checkbox\" \n                                checked={autoRefresh}\n                                onChange={toggleAutoRefresh}\n                            />\n                            <span className=\"slider\"></span>\n                            Auto Refresh\n                        </label>\n                    </div>\n                </div>\n            </div>\n            \n            {/* Metrics Grid */}\n            <div className=\"metrics-grid\">\n                {/* System Overview */}\n                <div className=\"metric-card\">\n                    <div className=\"card-header\">\n                        <span className=\"card-icon\">‚ö°</span>\n                        <span className=\"card-title\">System Status</span>\n                        <div className={`status-indicator ${connectionStatus ? 'online' : 'offline'}`}></div>\n                    </div>\n                    <div className=\"card-content\">\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">Uptime:</span>\n                            <span className=\"metric-value\">\n                                {formatUptime(systemData.uptime)}\n                            </span>\n                        </div>\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">Free RAM:</span>\n                            <span className=\"metric-value\">\n                                {formatBytes(systemData.memory)}\n                            </span>\n                        </div>\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">CPU Load:</span>\n                            <span className=\"metric-value\">\n                                {systemData.load}%\n                            </span>\n                        </div>\n                    </div>\n                </div>\n                \n                {/* WiFi Status */}\n                <div className=\"metric-card\">\n                    <div className=\"card-header\">\n                        <span className=\"card-icon\">üì∂</span>\n                        <span className=\"card-title\">WiFi Connection</span>\n                    </div>\n                    <div className=\"card-content\">\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">SSID:</span>\n                            <span className=\"metric-value\">\n                                {systemData.wifi.ssid || 'Not connected'}\n                            </span>\n                        </div>\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">Signal:</span>\n                            <span className=\"metric-value\">\n                                {systemData.wifi.rssi}dBm\n                            </span>\n                        </div>\n                        <div className=\"metric-row\">\n                            <span className=\"metric-label\">IP Address:</span>\n                            <span className=\"metric-value\">\n                                {systemData.wifi.ip || 'Unknown'}\n                            </span>\n                        </div>\n                    </div>\n                </div>\n                \n                {/* Sensor Data */}\n                {sensorData.map((sensor, index) => (\n                    <div key={index} className=\"metric-card\">\n                        <div className=\"card-header\">\n                            <span className=\"card-icon\">üå°Ô∏è</span>\n                            <span className=\"card-title\">Sensor {index + 1}</span>\n                        </div>\n                        <div className=\"card-content\">\n                            {sensor.Temperature && (\n                                <div className=\"metric-row\">\n                                    <span className=\"metric-label\">Temperature:</span>\n                                    <span className=\"metric-value highlight\">\n                                        {sensor.Temperature}¬∞C\n                                    </span>\n                                </div>\n                            )}\n                            {sensor.Humidity && (\n                                <div className=\"metric-row\">\n                                    <span className=\"metric-label\">Humidity:</span>\n                                    <span className=\"metric-value highlight\">\n                                        {sensor.Humidity}%\n                                    </span>\n                                </div>\n                            )}\n                            {sensor.Pressure && (\n                                <div className=\"metric-row\">\n                                    <span className=\"metric-label\">Pressure:</span>\n                                    <span className=\"metric-value highlight\">\n                                        {sensor.Pressure}hPa\n                                    </span>\n                                </div>\n                            )}\n                        </div>\n                    </div>\n                ))}\n            </div>\n            \n            {/* Charts */}\n            <div className=\"charts-grid\">\n                {/* Temperature Chart */}\n                <div className=\"chart-container\">\n                    <div className=\"chart-header\">\n                        <h3>Temperature Trend</h3>\n                        <div className=\"chart-controls\">\n                            <button className=\"chart-btn active\">1H</button>\n                            <button className=\"chart-btn\">6H</button>\n                            <button className=\"chart-btn\">24H</button>\n                        </div>\n                    </div>\n                    <div className=\"chart-wrapper\">\n                        <canvas ref={tempChartRef}></canvas>\n                    </div>\n                </div>\n                \n                {/* WiFi Signal Chart */}\n                <div className=\"chart-container\">\n                    <div className=\"chart-header\">\n                        <h3>WiFi Signal Strength</h3>\n                    </div>\n                    <div className=\"chart-wrapper\">\n                        <canvas ref={wifiChartRef}></canvas>\n                    </div>\n                </div>\n                \n                {/* System Load Chart */}\n                <div className=\"chart-container\">\n                    <div className=\"chart-header\">\n                        <h3>System Performance</h3>\n                    </div>\n                    <div className=\"chart-wrapper\">\n                        <canvas ref={powerChartRef}></canvas>\n                    </div>\n                </div>\n            </div>\n        </div>\n    );\n}\n\n// Utility functions\nfunction formatUptime(seconds) {\n    if (!seconds) return '--';\n    \n    const days = Math.floor(seconds / 86400);\n    const hours = Math.floor((seconds % 86400) / 3600);\n    const mins = Math.floor((seconds % 3600) / 60);\n    \n    if (days > 0) {\n        return `${days}d ${hours}h ${mins}m`;\n    } else if (hours > 0) {\n        return `${hours}h ${mins}m`;\n    } else {\n        return `${mins}m`;\n    }\n}\n\nfunction formatBytes(bytes) {\n    if (!bytes) return '--';\n    \n    const kb = bytes / 1024;\n    if (kb < 1024) {\n        return `${kb.toFixed(1)}KB`;\n    } else {\n        return `${(kb / 1024).toFixed(1)}MB`;\n    }\n}